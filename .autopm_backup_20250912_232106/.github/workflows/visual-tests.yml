name: Visual Regression Tests

on:
  push:
    branches: [main, develop, 'feature/*']
    paths:
      - 'src/react-frontend/**'
      - 'frontend/**'
      - 'package.json'
      - 'package-lock.json'
      - '.github/workflows/visual-tests.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'src/react-frontend/**'
      - 'frontend/**'
      - 'package.json'
      - 'package-lock.json'
  workflow_dispatch:
    inputs:
      update_snapshots:
        description: 'Update baseline snapshots'
        required: false
        type: boolean
        default: false

concurrency:
  group: visual-tests-${{ github.ref }}
  cancel-in-progress: true

env:
  # Visual testing environment variables
  FRONTEND_DIR: './src/react-frontend'
  # Kubernetes namespace for test services
  KUBE_NAMESPACE: 'github-runner'
  # Test server configuration
  TEST_SERVER_PORT: '3000'

jobs:
  visual-tests:
    name: Visual Regression Testing
    runs-on: [self-hosted, playwright, e2e]
    timeout-minutes: 30
    
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium]
        # Only chromium is available on GitHub runners
        # firefox and webkit require full browser installations
        
    permissions:
      contents: write
      pull-requests: write
      actions: write
      checks: write

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        working-directory: ./src/react-frontend
        run: |
          npm ci
          # Install Playwright browsers without sudo (already installed in runner)
          npx playwright install ${{ matrix.browser }} || echo "Browser may be pre-installed"

      - name: ğŸ“¸ Download baseline screenshots
        uses: actions/download-artifact@v4
        with:
          name: visual-snapshots-${{ matrix.browser }}
          path: ./src/react-frontend/tests/visual/__screenshots__
        continue-on-error: true

      - name: ğŸš€ Setup Test Environment
        working-directory: ${{ env.FRONTEND_DIR }}
        run: |
          echo "ğŸš€ Setting up test environment for visual testing..."
          
          # Build the app first
          echo "ğŸ—ï¸ Building frontend application..."
          npm run build || {
            echo "âš ï¸ Build failed, using development server"
            npm start &
            sleep 30
            echo "âœ… Development server ready"
            exit 0
          }
          
          # Check if we have a build to serve
          if [ -d "build" ]; then
            echo "ğŸ“¦ Build artifacts found, using static server..."
            
            # Use npx serve for simplicity - no Docker/K8s needed
            npx serve -s build -l ${{ env.TEST_SERVER_PORT }} &
            SERVE_PID=$!
            
            # Wait for server to be ready
            echo "â³ Waiting for static server to start..."
            sleep 10
            
            # Verify server is accessible
            if curl -s http://localhost:${{ env.TEST_SERVER_PORT }} > /dev/null; then
              echo "âœ… Static test server ready at http://localhost:${{ env.TEST_SERVER_PORT }}"
            else
              echo "âš ï¸ Static server not ready, falling back to dev server"
              kill $SERVE_PID || true
              npm start &
              sleep 30
            fi
          else
            echo "âš ï¸ No build artifacts, using development server"
            npm start &
            sleep 30
          fi
          
          # Final verification
          timeout 60 bash -c 'until curl -s http://localhost:${{ env.TEST_SERVER_PORT }} > /dev/null; do sleep 2; done' || echo "âš ï¸ Test server verification failed"

      - name: ğŸ­ Run visual tests
        id: visual-tests
        working-directory: ./src/react-frontend
        run: |
          if [ "${{ github.event.inputs.update_snapshots }}" == "true" ]; then
            echo "ğŸ“¸ Updating baseline snapshots..."
            npx playwright test tests/visual/visual.spec.ts \
              --project=${{ matrix.browser }} \
              --update-snapshots \
              --reporter=list,json,html
          else
            echo "ğŸ” Running visual regression tests..."
            npx playwright test tests/visual/visual.spec.ts \
              --project=${{ matrix.browser }} \
              --reporter=list,json,html
          fi
        env:
          CI: true
          PLAYWRIGHT_BROWSERS_PATH: 0

      - name: ğŸ“Š Generate visual diff report
        if: failure() && steps.visual-tests.outcome == 'failure'
        working-directory: ./src/react-frontend
        run: |
          echo "## ğŸ“¸ Visual Regression Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Browser: **${{ matrix.browser }}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Failed Tests:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          npx playwright show-report --host=0.0.0.0 --port=9323 &
          sleep 5
          curl -s http://localhost:9323 || echo "Report server not accessible"
          pkill -f "playwright show-report" || true
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“ Check the artifacts for detailed visual diff report" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ’¾ Upload baseline snapshots
        if: success() || github.event.inputs.update_snapshots == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: visual-snapshots-${{ matrix.browser }}
          path: ./src/react-frontend/tests/visual/__screenshots__
          retention-days: 30

      - name: ğŸ“Š Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: visual-test-results-${{ matrix.browser }}
          path: |
            ./src/react-frontend/playwright-report/
            ./src/react-frontend/test-results/
          retention-days: 7

      - name: ğŸ” Upload visual diffs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: visual-diffs-${{ matrix.browser }}
          path: |
            ./src/react-frontend/tests/visual/__screenshots__/**/*-diff.png
            ./src/react-frontend/tests/visual/__screenshots__/**/*-actual.png
          retention-days: 7

      - name: ğŸ§¹ Cleanup Test Environment
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up visual test environment..."
          
          # Kill any background processes
          pkill -f "npm start" || true
          pkill -f "npx serve" || true
          
          echo "âœ… Visual test cleanup completed"

      - name: ğŸ’¬ Comment on PR with results
        if: github.event_name == 'pull_request' && (success() || failure())
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const testResults = {
              browser: '${{ matrix.browser }}',
              status: '${{ steps.visual-tests.outcome }}',
              timestamp: new Date().toISOString()
            };
            
            let comment = `## ğŸ­ Visual Test Results - ${{ matrix.browser }}\n\n`;
            
            if (testResults.status === 'success') {
              comment += `âœ… **All visual tests passed!**\n\n`;
              comment += `Browser: ${{ matrix.browser }}\n`;
              comment += `No visual regressions detected.\n`;
            } else {
              comment += `âŒ **Visual regressions detected!**\n\n`;
              comment += `Browser: ${{ matrix.browser }}\n\n`;
              comment += `### Action Required:\n`;
              comment += `1. Review the visual differences in the artifacts\n`;
              comment += `2. If changes are intentional, update baselines\n`;
              comment += `3. If not intentional, fix the visual issues\n\n`;
              comment += `[View detailed report in artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n`;
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: ğŸš¦ Set check status
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ steps.visual-tests.outcome }}' === 'success' ? 'success' : 'failure';
            const conclusion = status === 'success' ? 'success' : 'failure';
            
            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'Visual Tests - ${{ matrix.browser }}',
              head_sha: context.sha,
              status: 'completed',
              conclusion: conclusion,
              output: {
                title: `Visual Tests - ${{ matrix.browser }}`,
                summary: status === 'success' 
                  ? `âœ… All visual tests passed for ${{ matrix.browser }}`
                  : `âŒ Visual regressions detected in ${{ matrix.browser }}`,
              }
            });

  visual-test-summary:
    name: Visual Test Summary
    runs-on: [self-hosted, playwright, e2e]
    needs: visual-tests
    if: always()
    
    steps:
      - name: ğŸ“Š Generate summary
        run: |
          echo "# ğŸ­ Visual Testing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Results:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Browser | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Chromium | ${{ needs.visual-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.visual-tests.result }}" == "success" ]; then
            echo "âœ… **All visual tests passed successfully!**" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Visual regressions detected. Please review the artifacts.**" >> $GITHUB_STEP_SUMMARY
          fi

      - name: ğŸš« Fail if visual tests failed
        if: needs.visual-tests.result == 'failure'
        run: |
          echo "âŒ Visual tests failed. PR cannot be merged."
          exit 1

  update-baselines:
    name: Update Baseline Snapshots
    runs-on: [self-hosted, playwright, e2e]
    if: github.event.inputs.update_snapshots == 'true'
    needs: visual-tests
    
    permissions:
      contents: write
      
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ“¸ Download updated snapshots
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      - name: ğŸ“¦ Organize snapshots
        run: |
          mkdir -p ./src/react-frontend/tests/visual/__screenshots__
          cp -r ./artifacts/visual-snapshots-*/* ./src/react-frontend/tests/visual/__screenshots__/ || true

      - name: ğŸ’¾ Commit updated baselines
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add ./src/react-frontend/tests/visual/__screenshots__
          git commit -m "ğŸ­ Update visual test baseline snapshots [skip ci]" || echo "No changes to commit"
          git push || echo "No changes to push"